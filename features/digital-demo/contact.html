<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Digital Test Environment</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/fontAwesome.css">
        <link rel="stylesheet" href="css/hero-slider.css">
        <link rel="stylesheet" href="css/owl-carousel.css">
        <link rel="stylesheet" href="css/templatemo-style.css">

        <link href="https://fonts.googleapis.com/css?family=Spectral:200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">


        <script type="text/javascript" src="https://resources.digital-cloud-west.medallia.com/wdcwest/23517/onsite/embed.js" async></script>
        <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
    </head>

<body>
    <div class="header">
        <div class="container">
            <a href="#" class="navbar-brand scroll-top">Anywhere</a>
            <nav class="navbar navbar-inverse" role="navigation">
                <div class="navbar-header">
                    <button type="button" id="nav-toggle" class="navbar-toggle" data-toggle="collapse" data-target="#main-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <!--/.navbar-header-->
                <div id="main-nav" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="index.html">Always-On</a></li>
                        <li><a href="menu.html">Intercept</a></li>
                        <li><a href="blog.html">Behaviour</a></li>
                        <li><a href="contact.html">Anywhere</a></li>
                    </ul>
                </div>
                <!--/.navbar-collapse-->
            </nav>
            <!--/.navbar-->
        </div>
        <!--/.container-->
    </div>
    <!--/.header-->


    <section class="page-heading">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1>Anywhere</h1>
                    <p>Show stopper, quase magia. Mas citando uma antiga feiticeira: não é magia, é tecnologia.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="Digital Anywhere — Demo">
        <div class="container">
<br><br><br><br>
<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0">
    <label style="min-width:180px" for="da-property-token"><strong>Property token</strong></label>
    <input id="da-property-token" type="password" placeholder="cole aqui (não exponha em produção)" style="padding:8px;min-width:280px" />
  </div>

  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0">
    <label style="min-width:180px" for="da-proxy"><strong>Proxy (Vercel)</strong></label>
    <input id="da-proxy" type="text" value="https://m-an-p.vercel.app/api" style="padding:8px;min-width:360px" />
    <span style="font-size:12px;background:#eef;border-radius:999px;padding:2px 8px">/api (minúsculo)</span>
  </div>

  <div style="margin:12px 0">
    <label for="da-form-id"><strong>Form alvo</strong></label><br/>
    <input id="da-form-id" type="number" value="25771" style="padding:8px;min-width:180px" />
  </div>

  <div style="margin:12px 0">
    <label for="da-config-json"><strong>Configuration payload (JSON)</strong></label>
    <textarea id="da-config-json" style="width:100%;min-height:200px;padding:10px;font-family:ui-monospace,Consolas,monospace">
{
  "channel": "anywhere",
  "event": "manual",
  "locale": "pt-BR",
  "page": { "url": "<?URL?>" },
  "variables": { "example_key": "example_value" }
}
    </textarea>
    <div style="color:#666;font-size:12px;margin-top:6px">
      A chamada é <strong>POST /configuration</strong> (sem query de form). O form alvo (ex.: 25771) é escolhido <em>na resposta</em>.
    </div>
  </div>

  <button id="da-start" style="padding:10px 14px;cursor:pointer">Abrir Digital Anywhere</button>

  <h3 style="margin-top:18px">Log</h3>
  <pre id="da-log" style="white-space:pre-wrap;background:#f6f8fa;padding:12px;border-radius:8px;font-size:12px"></pre>

  <!-- Modal -->
  <div id="da-modal" role="dialog" aria-modal="true"
       style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px">
    <div id="da-card" style="background:#fff;max-width:720px;width:100%;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.2);padding:20px;max-height:85vh;overflow:auto">
      <h3 id="da-form-title">Form</h3>
      <form id="da-form"></form>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button id="da-send" type="button" style="padding:10px 14px;cursor:pointer">Enviar</button>
        <button id="da-close" type="button" style="padding:10px 14px;cursor:pointer">Fechar</button>
      </div>
      <div id="da-msg" style="color:#666;font-size:12px;margin-top:8px"></div>
    </div>
  </div>
</section>

<script>
(function(){
  // ====== helpers UI ======
  const $ = (id) => document.getElementById(id);
  const logEl = $('da-log'), modal = $('da-modal'), formEl = $('da-form'),
        formTitleEl = $('da-form-title'), msgEl = $('da-msg');

  function log(msg, kind) {
    const p = kind === 'err' ? '❌ ' : kind === 'ok' ? '✅ ' : '• ';
    logEl.textContent += p + (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
  }
  const showModal = () => modal.style.display = 'flex';
  const hideModal = () => { modal.style.display='none'; formEl.innerHTML=''; msgEl.textContent=''; };

  // ====== formato do header exigido no /accessToken ======
  function asBearerUnderscore(token) {
    const t = String(token || '').trim();
    return /^bearer[_\s]/i.test(t) ? t : `bearer_${t}`;
  }

  // ====== chamadas ao PROXY (Vercel) ======
  async function exchangeAccessToken(proxyBase, propertyToken) {
    // Tenta trocar; se 401, retorna null (vamos fazer fallback)
    const res = await fetch(`${proxyBase}/accessToken`, {
      method: 'POST',
      headers: { Authorization: asBearerUnderscore(propertyToken) }
    });
    if (!res.ok) return null;
    const data = await res.json().catch(() => ({}));
    return data.accessToken || data.token || data.access_token || data.raw || null;
  }

  async function postConfiguration(proxyBase, accessToken, payload) {
    const res = await fetch(`${proxyBase}/configuration`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ accessToken, payload })
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      throw new Error(`configuration falhou: ${res.status} ${t}`);
    }
    return res.json();
  }

  async function sendFeedback(proxyBase, accessToken, payload) {
    const res = await fetch(`${proxyBase}/feedback`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ accessToken, ...payload })
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      throw new Error(`feedback falhou: ${res.status} ${t}`);
    }
    return res.json().catch(() => ({}));
  }

  // ====== busca recursiva do form alvo (por id) ======
  function findFormNode(root, targetId) {
    const seen = new WeakSet();
    function walk(node) {
      if (!node || typeof node !== 'object' || seen.has(node)) return null;
      seen.add(node);
      if ((node.id == targetId || node.formId == targetId) && (node.fields || node.form?.fields || node.formDefinition?.fields)) {
        return node;
      }
      for (const k of Object.keys(node)) {
        const v = node[k];
        if (v && typeof v === 'object') {
          const found = walk(v);
          if (found) return found;
        }
      }
      return null;
    }
    return walk(root);
  }

  function extractFields(node) {
    if (!node) return { title: '', fields: [] };
    const title = node.name || node.title || node.form?.name || node.form?.title || `Form ${node.id || node.formId || ''}`;
    const fields = node.fields || node.form?.fields || node.formDefinition?.fields || [];
    return { title, fields };
  }

  function buildInput(field) {
    const wrap = document.createElement('div');
    wrap.style.display = 'flex';
    wrap.style.gap = '8px';
    wrap.style.alignItems = 'center';
    wrap.style.margin = '12px 0';

    const label = document.createElement('label');
    const id = `f_${field.id || field.name || Math.random().toString(36).slice(2)}`;
    label.setAttribute('for', id);
    label.textContent = field.label || field.name || field.id || 'Campo';
    label.style.minWidth = '180px';

    let input;
    const type = (field.type || '').toLowerCase();

    if (type.includes('select') || Array.isArray(field.options)) {
      input = document.createElement('select');
      const ph = document.createElement('option'); ph.value=''; ph.textContent='— selecione —';
      input.appendChild(ph);
      (field.options || []).forEach(opt => {
        const o = document.createElement('option');
        o.value = (opt.value ?? opt.id ?? opt);
        o.textContent = (opt.label ?? opt.name ?? String(opt));
        input.appendChild(o);
      });
    } else if (type.includes('multi') || type.includes('textarea')) {
      input = document.createElement('textarea'); input.rows = 3;
    } else if (type.includes('email')) {
      input = document.createElement('input'); input.type = 'email';
    } else if (type.includes('phone')) {
      input = document.createElement('input'); input.type = 'tel';
    } else if (type.includes('number') || type.includes('rating')) {
      input = document.createElement('input'); input.type = 'number';
    } else if (type.includes('boolean') || type.includes('checkbox')) {
      input = document.createElement('input'); input.type = 'checkbox';
    } else {
      input = document.createElement('input'); input.type = 'text';
    }

    input.id = id;
    input.dataset.fieldId = field.id || field.name || id;
    if (field.required) input.required = true;

    input.style.padding = '8px';
    input.style.minWidth = '260px';

    wrap.appendChild(label);
    wrap.appendChild(input);
    return wrap;
  }

  function collectAnswers() {
    const controls = formEl.querySelectorAll('[data-field-id]');
    const answers = [];
    controls.forEach(ctrl => {
      const fieldId = ctrl.dataset.fieldId;
      const value = (ctrl.type === 'checkbox') ? ctrl.checked : ctrl.value;
      answers.push({ fieldId, value });
    });
    return answers;
  }

  // ====== fluxo ======
  $('da-start').addEventListener('click', async () => {
    log('Iniciando fluxo...');
    const proxyBase = $('da-proxy').value.trim();
    const propertyToken = $('da-property-token').value.trim();
    const targetFormId = $('da-form-id').value.trim();

    let payloadText = $('da-config-json').value.replace('<?URL?>', location.href);
    let payload;
    try { payload = JSON.parse(payloadText); }
    catch(e) { log('JSON do payload inválido.', 'err'); return; }

    if (!proxyBase || !propertyToken) {
      log('Preencha Proxy e Property token.', 'err');
      return;
    }

    try {
      log('Trocando property token por accessToken...');
      let accessToken = await exchangeAccessToken(proxyBase, propertyToken);

      if (!accessToken) {
        log('Exchange 401/sem token — usando o property token como accessToken (fallback).');
        accessToken = propertyToken; // assume que já é accessToken
      } else {
        log('Access token OK.', 'ok');
      }

      log('Chamando POST /configuration com payload...');
      const conf = await postConfiguration(proxyBase, accessToken, payload);
      log(conf);

      const node = findFormNode(conf, targetFormId);
      if (!node) { log(`Form ${targetFormId} não encontrado na resposta do configuration.`, 'err'); return; }

      const { title, fields } = extractFields(node);
      formTitleEl.textContent = title || `Form ${targetFormId}`;
      formEl.innerHTML = '';

      if (!fields.length) {
        const warn = document.createElement('div');
        warn.style.color = '#b00020';
        warn.textContent = 'Nenhum campo encontrado nesse form. Veja o LOG acima para inspecionar a resposta.';
        formEl.appendChild(warn);
      } else {
        fields.forEach(f => formEl.appendChild(buildInput(f)));
      }

      showModal();

      $('da-send').onclick = async () => {
        msgEl.textContent = 'Enviando...';
        try {
          const responses = collectAnswers();
          const out = await sendFeedback(proxyBase, accessToken, {
            formId: Number(targetFormId),
            responses,
            channel: payload.channel || 'anywhere',
            locale: payload.locale || 'pt-BR'
          });
          log('Feedback enviado.', 'ok');
          log(out);
          msgEl.style.color = '#0a7a2f';
          msgEl.textContent = 'Feedback enviado com sucesso!';
        } catch (e) {
          msgEl.style.color = '#b00020';
          msgEl.textContent = 'Falha ao enviar feedback — veja o log.';
          log(e.message || e, 'err');
        }
      };

      $('da-close').onclick = () => hideModal();

    } catch (e) {
      log(e.message || e, 'err');
    }
  });
})();
</script>
        </div>
    </section>

    
    <section class="contact-us">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="section-heading">
                        <h2>Message</h2>
                    </div>
                    <form id="contact" action="" method="post">
                        <div class="row">
                            <div class="col-md-6">
                                <fieldset>
                                    <input name="name" type="text" class="form-control" id="name" placeholder="Your name..." required="">
                                </fieldset>
                                <fieldset>
                                    <input name="email" type="text" class="form-control" id="email" placeholder="Your email..." required="">
                                </fieldset>
                                <fieldset>
                                    <input name="phone" type="text" class="form-control" id="phone" placeholder="Your phone..." required="">
                                </fieldset>
                            </div>
                            <div class="col-md-6">
                                <fieldset>
                                    <textarea name="message" rows="6" class="form-control" id="message" placeholder="Your message..." required=""></textarea>
                                </fieldset>
                                <fieldset>
                                    <button type="submit" id="form-submit" class="btn">Send Message</button>
                                </fieldset>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-md-6">
                    <div class="section-heading contact-info">
                        <h2>Contact Info</h2>
                        <p>Pellentesque nec orci in erat venenatis viverra. Vivamus in lorem et leo feugiat ullamcorper. Donec volutpat fermentum erat non aliquet. Cras fermentum, risus a blandit sodales, erat turpis eleifend lacus, venenatis mollis leo lorem vel eros. Quisque et sem tempus, feugiat urna iaculis, tempor metus.<br><br><em>30 Raffles Ave, <br>Singapore 039803</em></p>
                    </div>
                    <p>
                    <button type="submit" id="form-submit" class="btn">Send Message</button>
                        </p>
                </div>
            </div>
        </div>
    </section>



    <section class="map">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div id="map">
        <!-- How to change your own map point
            1. Go to Google Maps
            2. Click on your location point
            3. Click "Share" and choose "Embed map" tab
            4. Copy only URL and paste it within the src="" field below
        -->
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d7895.485196115994!2d103.85995441789784!3d1.2880401763270322!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x7fb4e58ad9cd826e!2sSingapore+Flyer!5e0!3m2!1sen!2sth!4v1505825620371" width="100%" height="500" frameborder="0" style="border:0" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <p>Copyright &copy; 2020 Victory Template</p>
                </div>
                <div class="col-md-4">
                    <ul class="social-icons">
                        <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                        <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                        <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
                        <li><a href="#"><i class="fa fa-rss"></i></a></li>
                        <li><a href="#"><i class="fa fa-dribbble"></i></a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <p>Design: TemplateMo</p>
                </div>
            </div>
        </div>
    </footer>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>

    <script src="js/vendor/bootstrap.min.js"></script>

    <script src="js/plugins.js"></script>
    <script src="js/main.js"></script>

    <script type="text/javascript">
    $(document).ready(function() {
        // navigation click actions 
        $('.scroll-link').on('click', function(event){
            event.preventDefault();
            var sectionID = $(this).attr("data-id");
            scrollToID('#' + sectionID, 750);
        });
        // scroll to top action
        $('.scroll-top').on('click', function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop:0}, 'slow');         
        });
        // mobile nav toggle
        $('#nav-toggle').on('click', function (event) {
            event.preventDefault();
            $('#main-nav').toggleClass("open");
        });
    });
    // scroll function
    function scrollToID(id, speed){
        var offSet = 0;
        var targetOffset = $(id).offset().top - offSet;
        var mainNav = $('#main-nav');
        $('html,body').animate({scrollTop:targetOffset}, speed);
        if (mainNav.hasClass("open")) {
            mainNav.css("height", "1px").removeClass("in").addClass("collapse");
            mainNav.removeClass("open");
        }
    }
    if (typeof console === "undefined") {
        console = {
            log: function() { }
        };
    }
    </script>
</body>

</html>













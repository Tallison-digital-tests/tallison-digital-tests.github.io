<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forms – Quick Launcher + Triggers Simulator</title>
  <style>
    :root { --bg:#50d9ff; --btn:#2f2f2f; --btnHover:#1f1f1f; --txt:#fff; --card:#ffffff; --ink:#101010; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; min-height: 100vh; background: var(--bg); display: grid; place-items: start center; }
    .wrap { width: min(1200px, 100%); }
    h1 { margin: 0 0 8px; font-size: 20px; font-weight: 800; text-align: center; color: var(--ink); }
    p.note { margin: 0 0 16px; text-align: center; color: var(--ink); opacity: .8; }

    .panel, .forms {
      background: var(--card); color: var(--ink);
      border-radius: 12px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.12);
      margin-bottom: 16px;
    }
    .panel h2, .forms h2 { margin: 0 0 12px; font-size: 16px; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-3 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }

    label { display:block; font-size: 12px; font-weight: 700; margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #ddd; background: #fff; color: var(--ink);
    }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .check-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    .check-row label { font-weight: 600; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px; background: #f2f2f2; font-size: 12px;
    }
    .actions { display:flex; gap:10px; flex-wrap: wrap; margin-top: 8px;}
    button {
      padding: 10px 14px; border-radius: 8px; border: 0; cursor: pointer; background: var(--btn); color: var(--txt); font-weight: 700;
    }
    button:hover { background: var(--btnHover); }
    .muted { opacity: .7; font-size: 12px; }

    /* Forms grid */
    .forms .grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    button.form-btn { display:none; width: 100%; text-align: left; }
    .id { opacity: .7; font-size: 12px; display:block; margin-top: 4px; }
    pre.debug { background:#0e0e0e; color:#eaeaea; padding:12px; border-radius:8px; overflow:auto; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">

    <h1>Onsite Forms – Launcher & Triggers Simulator</h1>
    <p class="note">Monte abaixo um cenário (env/país/idioma/rota/params). O URL é simulado com <code>history.pushState</code> para parecer um <em>claim-success</em>, <em>update-payment-success</em>, <em>user-profile</em> ou <em>billing-info</em>.</p>

    <!-- Scenario Builder -->
    <section class="panel">
      <h2>Scenario Builder</h2>
      <div class="grid cols-3">
        <div>
          <label>Environment</label>
          <select id="envSel">
            <option value="prod">prod – apac.myaccount.chubb.com</option>
            <option value="uat">uat – apac.myaccount-uat.chubb.com</option>
            <option value="sit">sit – apac.myaccount-sit.chubb.com</option>
          </select>
        </div>
        <div>
          <label>Country</label>
          <select id="ctySel">
            <option value="sg">SG (Singapore)</option>
            <option value="hk">HK (Hong Kong)</option>
            <option value="th">TH (Thailand)</option>
            <option value="my">MY (Malaysia)</option>
          </select>
        </div>
        <div>
          <label>Locale</label>
          <select id="locSel">
            <!-- será ajustado dinamicamente conforme o país -->
          </select>
        </div>

        <div>
          <label>Route / Trigger</label>
          <select id="routeSel">
            <option value="claim-success">/claim-success (Claim Submission)</option>
            <option value="update-payment-success">/update-payment-success (Update Credit Card)</option>
            <option value="user-profile">/user-profile (Update Contact Details)</option>
            <option value="billing-info">/billing-info (Billing History)</option>
          </select>
        </div>

        <div>
          <label>policyNumber (URL param)</label>
          <input id="policyInput" type="text" placeholder="e.g., S6-987654"/>
        </div>
        <div>
          <label>fnolId (URL param)</label>
          <input id="fnolInput" type="text" placeholder="e.g., 12345"/>
        </div>

        <div>
          <label>update-payment-success (URL param)</label>
          <select id="upsParam">
            <option value="">(omit)</option>
            <option value="true">true</option>
            <option value="1">1</option>
          </select>
        </div>
        <div>
          <label>lossType (Cookie)</label>
          <input id="lossTypeInput" type="text" placeholder="e.g., Auto"/>
        </div>
        <div>
          <label>claimNum (Cookie, nullable)</label>
          <input id="claimNumInput" type="text" placeholder="e.g., CLM-001 (or leave empty)"/>
        </div>

        <div>
          <label>enableContactUpdateSurvey (Cookie)</label>
          <select id="enableCUSel">
            <option value="">(omit)</option>
            <option value="true">true</option>
            <option value="1">1</option>
          </select>
        </div>
        <div>
          <label>Auth State (Session Storage <code>CS_AUTH</code>)</label>
          <select id="authSel">
            <option value="guest">guest (isLoggedIn=false)</option>
            <option value="auth">authenticated (isLoggedIn=true)</option>
          </select>
        </div>
        <div>
          <label>fs_uid (Session Storage)</label>
          <input id="fsuidInput" type="text" placeholder="auto-generated if empty"/>
        </div>
      </div>

      <div class="actions">
        <button id="applyBtn">Apply Scenario (Set URL + Storage + Cookies)</button>
        <button id="updateBtn" type="button">Update Page View</button>
        <button id="clearBtn">Clear Cookies/Storage</button>
        <span class="pill"><strong>Country</strong> & <strong>Locale</strong> also saved for filters</span>
      </div>

      <div class="grid cols-2" style="margin-top:12px;">
        <div>
          <label>Effective URL</label>
          <pre id="urlOut" class="debug"></pre>
        </div>
        <div>
          <label>Parsed Variables Preview</label>
          <pre id="varsOut" class="debug"></pre>
        </div>
      </div>
      <p class="muted">Dica: depois de “Apply”, você pode abrir/atualizar os forms abaixo. O SDK vai capturar essa ambientação.</p>
    </section>

    <!-- Forms Launcher -->
    <section class="forms">
      <h2>Launch a Form</h2>
      <div id="btnGrid" class="grid"></div>
    </section>
  </div>

  <!-- Medallia Digital Anywhere Onsite -->
  <script src="https://resources.digital-cloud.medallia.eu/wdceu/217941/onsite/embed.js" async></script>

<script>
  // =======================
  // CONFIG – keys & mapping
  // =======================
  const KEYS = {
    fs_uid: "fs_uid",
    cs_auth: "CS_AUTH",
    lossType: "lossType",
    claimNum: "claimNum",
    enableContactUpdateSurvey: "enableContactUpdateSurvey",
    countryVar: "country",
    langVar: "lang"
  };

  const CSP_MAP = {
    "apac.myaccount.chubb.com": "csp-prod",
    "apac.myaccount-uat.chubb.com": "csp-uat",
    "apac.myaccount-sit.chubb.com": "csp-sit",
    locationHostFallback: "csp-local"
  };

  const LOCALES = {
    sg: ["en-SG"],
    hk: ["en-HK","cn-HK"],
    th: ["en-TH","th-TH"],
    my: ["en-MY","ms-MY"]
  };

  const FORMS = [
    { name: "MyAccount - VIEWING BILLING HISTORY - MY", id: 33486 },
    { name: "MyAccount - UPDATE CONTACT DETAILS - MY", id: 33484 },
    { name: "MyAccount - UPDATE CREDIT CARD - MY", id: 33481 },
    { name: "MyAccount - VIEW BILLING HISTORY - SG", id: 33480 },
    { name: "MyAccount - UPDATE CONTACT DETAILS - SG", id: 33479 },
    { name: "MyAccount - UPDATE CREDIT CARD - SG", id: 33478 },
    { name: "MyAccount - UPDATE CONTACT DETAILS - TH", id: 33477 },
    { name: "MyAccount - UPDATE CONTACT DETAILS - CN", id: 33474 },
    { name: "MyAccount - VIEWING BILLING HISTORY - CN", id: 33475 },
    { name: "MyAccount - UPDATE CREDIT CARD - CN", id: 33460 },
    { name: "MyAccount - CLAIM SUBMISSION - MY", id: 33042 },
    { name: "MyAccount - CLAIM SUBMISSION - TH", id: 33043 },
    { name: "MyAccount - CLAIM SUBMISSION - SG", id: 32915 },
    { name: "MyAccount - CLAIM SUBMISSION - CN", id: 33041 }
  ];

  // ===== UI refs (elementos já existentes no seu HTML) =====
  const grid = document.getElementById("btnGrid");
  const envSel = document.getElementById("envSel");
  const ctySel = document.getElementById("ctySel");
  const locSel = document.getElementById("locSel");
  const routeSel = document.getElementById("routeSel");
  const policyInput = document.getElementById("policyInput");
  const fnolInput = document.getElementById("fnolInput");
  const upsParam = document.getElementById("upsParam");
  const lossTypeInput = document.getElementById("lossTypeInput");
  const claimNumInput = document.getElementById("claimNumInput");
  const enableCUSel = document.getElementById("enableCUSel");
  const authSel = document.getElementById("authSel");
  const fsuidInput = document.getElementById("fsuidInput");
  const urlOut = document.getElementById("urlOut");
  const varsOut = document.getElementById("varsOut");

  // ==== pequenos utilitários ====
  function refreshLocales() {
    const c = ctySel.value;
    const opts = LOCALES[c] || [];
    locSel.innerHTML = "";
    opts.forEach(l => {
      const o = document.createElement("option");
      o.value = l; o.textContent = l;
      locSel.appendChild(o);
    });
  }
  ctySel?.addEventListener("change", refreshLocales);
  refreshLocales();

  function setCookie(name, value) {
    if (!value) { document.cookie = `${name}=; Max-Age=0; path=/`; return; }
    document.cookie = `${name}=${encodeURIComponent(value)}; path=/; SameSite=Lax`;
  }
  function clearCookie(name) { document.cookie = `${name}=; Max-Age=0; path=/`; }
  function randomUID() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

  // ==== constrói apenas PATH relativo (mesma origem) ====
  function buildRelativePath() {
    const country = ctySel.value;       // sg/hk/th/my
    const locale  = locSel.value;       // en-SG, cn-HK, ...
    const route   = routeSel.value;     // claim-success, update-payment-success, ...
    const base    = `/myaccount/${country}/default/default/default/${locale}/${route}`;
    const params  = new URLSearchParams();
    if (policyInput.value) params.set("policyNumber", policyInput.value);
    if (fnolInput.value)   params.set("fnolId", fnolInput.value);
    if (upsParam.value && route === "update-payment-success") {
      params.set("update-payment-success", upsParam.value);
    }
    const qs = params.toString();
    return qs ? `${base}?${qs}` : base;
  }

  // =========================
  // updatePageView automágico
  // =========================
  function notifyDigital() {
    const doUpdate = () => {
      try {
        if (window.KAMPYLE_ONSITE_SDK?.updatePageView) {
          window.KAMPYLE_ONSITE_SDK.updatePageView();
        }
      } catch (e) { console.warn("updatePageView falhou:", e); }
    };
    if (window.KAMPYLE_ONSITE_SDK?.updatePageView) doUpdate();
    else {
      const once = () => { window.removeEventListener("neb_OnsiteLoaded", once); doUpdate(); };
      window.addEventListener("neb_OnsiteLoaded", once);
    }
  }

  // =========
  // DEBUG UI
  // =========
  const actionsBar = document.querySelector(".actions");
  const debugBox = document.createElement("label");
  debugBox.style.display = "inline-flex"; debugBox.style.alignItems = "center"; debugBox.style.gap = "6px";
  debugBox.innerHTML = `<input id="dbgAll" type="checkbox"/> <span class="muted">Debug: show all buttons (ignore availability)</span>`;
  actionsBar?.appendChild(debugBox);

  // >>> Botão "Update Page View" (criado se não existir no HTML) <<<
  let updateBtn = document.getElementById("updateBtn");
  if (!updateBtn && actionsBar) {
    updateBtn = document.createElement("button");
    updateBtn.id = "updateBtn";
    updateBtn.type = "button";
    updateBtn.textContent = "Update Page View";
    // tenta inserir antes do botão de limpar, se houver; senão, apenas adiciona ao final
    const clearBtnEl = document.getElementById("clearBtn");
    clearBtnEl ? actionsBar.insertBefore(updateBtn, clearBtnEl) : actionsBar.appendChild(updateBtn);
  }
  updateBtn?.addEventListener("click", notifyDigital);

  const dbgAll = document.getElementById("dbgAll");

  function revealAvailableForms() {
    try {
      FORMS.forEach(({ id }) => {
        const b = document.getElementById("btn_" + id);
        if (!b) return;
        if (dbgAll?.checked) { b.style.display = "block"; return; }
        const ok = window.KAMPYLE_ONSITE_SDK?.loadForm ? window.KAMPYLE_ONSITE_SDK.loadForm(id) : false;
        b.style.display = ok ? "block" : "none";
      });
    } catch (e) { console.error("Erro ao inicializar os forms:", e); }
  }
  dbgAll?.addEventListener("change", revealAvailableForms);

  // =========
  // Previews
  // =========
  function previewVars() {
    const u = new URL(location.href);
    const segs = u.pathname.split("/").filter(Boolean);
    // ex esperado: ["myaccount","{cty}","default","default","default","{locale}","{route}"]
    const country = segs[1] || "";
    const locale  = segs[6] || "";
    theRoute = segs[7] || "";
    const vars = {
      csp_id: CSP_MAP[u.host] || CSP_MAP.locationHostFallback,
      country, locale, route: theRoute,
      params: Object.fromEntries(u.searchParams.entries()),
      cookies: document.cookie,
      sessionStorage: Object.fromEntries(Object.entries(sessionStorage))
    };
    varsOut.textContent = JSON.stringify(vars, null, 2);
  }

  // ============================
  // APPLY SCENARIO (principal)
  // ============================
  function applyScenario() {
    // Session Storage
    const uid = fsuidInput.value || randomUID();
    sessionStorage.setItem(KEYS.fs_uid, uid);
    const auth = (authSel.value === "auth");
    sessionStorage.setItem(KEYS.cs_auth, JSON.stringify({ isLoggedIn: auth }));

    // Cookies
    setCookie(KEYS.lossType,               lossTypeInput.value || "");
    if (claimNumInput.value) setCookie(KEYS.claimNum, claimNumInput.value); else clearCookie(KEYS.claimNum);
    if (enableCUSel.value)   setCookie(KEYS.enableContactUpdateSurvey, enableCUSel.value); else clearCookie(KEYS.enableContactUpdateSurvey);

    // Path relativo (mesma origem) — importante pro SDK enxergar /claim-success etc.
    const rel = buildRelativePath();
    history.pushState({}, "", rel);

    // Opcional: guardar country/lang como filtros auxiliares
    const segs = location.pathname.split("/").filter(Boolean);
    sessionStorage.setItem(KEYS.countryVar, segs[1] || "");
    sessionStorage.setItem(KEYS.langVar, segs[6] || "");

    // Atualiza painéis e forms
    document.getElementById("urlOut").textContent = location.href;
    previewVars();

    // 🔔 Dispara o updatePageView automaticamente
    notifyDigital();

    // Após o update, atualiza a disponibilidade dos forms
    setTimeout(revealAvailableForms, 200);
  }

  // Botões já existentes
  document.getElementById("applyBtn")?.addEventListener("click", applyScenario);
  document.getElementById("clearBtn")?.addEventListener("click", () => {
    [KEYS.lossType, KEYS.claimNum, KEYS.enableContactUpdateSurvey].forEach(clearCookie);
    [KEYS.fs_uid, KEYS.cs_auth, KEYS.countryVar, KEYS.langVar].forEach(k => sessionStorage.removeItem(k));
    varsOut.textContent = "{}";
  });

  // Cria botões de forms
  FORMS.forEach(({ name, id }) => {
    const btn = document.createElement("button");
    btn.className = "form-btn"; btn.id = "btn_" + id;
    btn.innerHTML = `${name} <span class="id">Form ID: ${id}</span>`;
    btn.addEventListener("click", () => {
      try { window.KAMPYLE_ONSITE_SDK?.showForm(id); }
      catch (e) { console.error("showForm error", e); }
    });
    grid.appendChild(btn);
  });

  // Quando o SDK carregar, atualiza preview, disponibilidade e dá um updatePageView
  function onsiteLoaded() {
    document.getElementById("urlOut").textContent = location.href;
    previewVars();
    revealAvailableForms();
    notifyDigital(); // garante o trigger na carga inicial também
  }
  if (window.KAMPYLE_ONSITE_SDK) onsiteLoaded();
  else window.addEventListener("neb_OnsiteLoaded", onsiteLoaded);
</script>
</body>
</html>
